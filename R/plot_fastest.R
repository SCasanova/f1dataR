#' Load Session Data
#'
#' Loads telemetry and general data from the official F1
#' data stream via the fastf1 python library. Data is available from
#' 2018 onward.
#'
#' @param season number from 2018 to 2022 (defaults to current season).
#' @param race number from 1 to 23 (depending on season selected) and defaults
#' to most recent.
#' @param driver three letter driver code (see load_drivers() for a list)
#' @param color argument that indicates which variable to plot overtop the
#' circuit
#' @importFrom magrittr "%>%"
#' @import ggplot2
#' @return A ggplot object that indicates grand prix, driver, time and selected
#' color variable.


plot_fastest <- function(season, race, driver, color = 'gear'){
  message("If the session has not been loaded yet, this could take a minute\n\n")

  driver_data <- get_driver_telemetry(season, race, driver, T)

  driver_id <- load_drivers(season) %>%
    dplyr::filter(code == driver) %>%
    dplyr::pull(driverId)

  lap_time <- load_laps(2022, race) %>%
    dplyr::filter(driverId == driver_id) %>%
    dplyr::filter(time_sec == min(.[, 'time_sec'])) %>%
    dplyr::pull(time)

  race <- load_schedule(season) %>%
    dplyr::filter(round == race) %>%
    dplyr::pull(race_name)

  if(color == 'gear'){
    ggplot2::ggplot(driver_data, ggplot2::aes(X, Y, color = as.factor(nGear), group = Time)) +
      ggplot2::geom_path(size = 4, lineend = 'round') +
      ggsci::scale_color_nejm(name = 'Gear') +
      ggdark::dark_theme_gray() +
      ggplot2::theme(
        panel.grid = element_blank(),
        axis.line = element_blank(),
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        plot.title  = element_text(face = 'bold', size = 17, color = '#cf1b1f'),
        plot.subtitle  = element_text(face = 'bold', size = 14),
        plot.background = element_rect(fill = "grey10"),
        panel.background = element_blank(),
        legend.background = element_blank(),
        legend.key = element_blank(),
        plot.caption = element_text(size = 8, color = 'white')
      ) +
      ggplot2::labs(title = race,
                    subtitle = paste0(driver, ' Fastest Lap | ', lap_time),
                     caption = 'Generated by {f1dataR} package'
                    )
  } else if(color == 'speed'){
    ggplot2::ggplot(driver_data, ggplot2::aes(X, Y, color = Speed, group = Time)) +
      ggplot2::geom_path(size = 4, lineend = 'round') +
      ggplot2::scale_color_gradient(low = 'white', high = 'red')+
      ggdark::dark_theme_gray() +
      ggplot2::theme(
        panel.grid = element_blank(),
        axis.line = element_blank(),
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        plot.title  = element_text(face = 'bold', size = 17, color = '#cf1b1f'),
        plot.subtitle  = element_text(face = 'bold', size = 14),
        plot.background = element_rect(fill = "grey10"),
        panel.background = element_blank(),
        legend.background = element_blank(),
        legend.key = element_blank(),
        plot.caption = element_text(size = 8, color = 'white')
      ) +
      ggplot2::labs(title = race,
                    subtitle = paste0(driver, ' Fastest Lap | ', lap_time),
                    caption = 'Generated by {f1dataR} package')
  }

}
